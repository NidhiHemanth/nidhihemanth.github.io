<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Optimizing Linux | sn99</title>
<meta name="keywords" content="Windows, Drivers, minifilter, VirtualKD-Redux">
<meta name="description" content="I am writing this guide to save my progress and let others contribute to increasing linux performance even further; after all, many are better than one. You can use all of them or just a few of them. Read a topic fully before starting.
I am currently on Nobara, so some steps may vary from distro to distro.
NOTE: This guide is not for beginners who are new to Linux but a few of them can be used safely by them.">
<meta name="author" content="sn99">
<link rel="canonical" href="https://nidhihemanth.github.io./blogs/optimizing-linux/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e087fd1dc76e73a35ae6d7028ddc1ba41e0131e7f9b3a6e2d019a208e6d6c4b5.css" integrity="sha256-4If9Hcduc6Na5tcCjdwbpB4BMef5s6bi0BmiCObWxLU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://nidhihemanth.github.io./favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nidhihemanth.github.io./favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nidhihemanth.github.io./favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nidhihemanth.github.io./apple-touch-icon.png">
<link rel="mask-icon" href="https://nidhihemanth.github.io./safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Optimizing Linux" />
<meta property="og:description" content="I am writing this guide to save my progress and let others contribute to increasing linux performance even further; after all, many are better than one. You can use all of them or just a few of them. Read a topic fully before starting.
I am currently on Nobara, so some steps may vary from distro to distro.
NOTE: This guide is not for beginners who are new to Linux but a few of them can be used safely by them." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nidhihemanth.github.io./blogs/optimizing-linux/" /><meta property="article:section" content="blogs" />
<meta property="article:published_time" content="2021-01-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-26T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Optimizing Linux"/>
<meta name="twitter:description" content="I am writing this guide to save my progress and let others contribute to increasing linux performance even further; after all, many are better than one. You can use all of them or just a few of them. Read a topic fully before starting.
I am currently on Nobara, so some steps may vary from distro to distro.
NOTE: This guide is not for beginners who are new to Linux but a few of them can be used safely by them."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://nidhihemanth.github.io./blogs/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Optimizing Linux",
      "item": "https://nidhihemanth.github.io./blogs/optimizing-linux/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Optimizing Linux",
  "name": "Optimizing Linux",
  "description": "I am writing this guide to save my progress and let others contribute to increasing linux performance even further; after all, many are better than one. You can use all of them or just a few of them. Read a topic fully before starting.\nI am currently on Nobara, so some steps may vary from distro to distro.\nNOTE: This guide is not for beginners who are new to Linux but a few of them can be used safely by them.",
  "keywords": [
    "Windows", "Drivers", "minifilter", "VirtualKD-Redux"
  ],
  "articleBody": "I am writing this guide to save my progress and let others contribute to increasing linux performance even further; after all, many are better than one. You can use all of them or just a few of them. Read a topic fully before starting.\nI am currently on Nobara, so some steps may vary from distro to distro.\nNOTE: This guide is not for beginners who are new to Linux but a few of them can be used safely by them.\nIndex Compiling your kernel Applying patches Removing your own compiled kernel Btrfs filesystem optimizations Changing boot parameters Improving boot time Changing swappiness Changing scaling_governor to performance Improving graphic card performance Some other tweaks Compiling your kernel By now, everyone agrees that compiling your kernel is one of the best options to get the fastest possible speed. You might want to google How to make custom kernel in to get the packages required to compile the kernel.\nDownload the latest kernel or whatever you like. Extract it; I am going to assume a generic name from now on linux-x.x.x.\nThe next step is finding the config file. Most of the time, you can run:\ncp -v /boot/config-$(uname -r) .config From inside linux-x.x.x, which should give an output like:\n'/boot/config-y.y.y-generic' -\u003e '.config' if it fails, you can find config in /proc/config.gz or simple run make listnewconfig OR make oldconfig(it usually starts a long process; try finding your config in your distro source code too).\nEdit Makefile and change EXTRAVERSION to add something. For example, “EXTRAVERSION = ”.\n(You might want to see the next subtopic before doing this) Now run make xconfig. Now a lot of optimizations are possible Here, many dead codes and modules can be removed and enabled. Let’s go the safe road for now.\nNow, one of the best things you can do is no longer build for a generic kernel. Select - Processor type and features - Processor family - [x] Core2/newer Xeon It should have been Generic-x86-64 by default. There is a lot of other stuff you can do too, but you will have to read them and see which suits you best. A simple way might be to just copy clear linux config, but it might disable certain features (see next Applying patches). Now, you might want to run:\ndmesg --level=err dmesg --level=warn To see if you can enable some extra flags for extra features. For example, psmouse serio1: elantech: The touchpad can support a better bus than the old PS/2 protocol. Make sure MOUSE_PS2_ELANTECH_SMBUS and MOUSE_ELAN_I2C_SMBUS are enabled to get a better touchpad experience. can be solved by enabling both of them.\nFinally, compiling the kernel:\n# sed -ri '/CONFIG_SYSTEM_TRUSTED_KEYS/s/=.+/=\"\"/g' .config make -j N CFLAGS='-march=native -O3 -flto -pipe' CXXFLAGS='-march=native -O3 -flto -pipe' make -j N CFLAGS='-march=native -O3 -flto -pipe' CXXFLAGS='-march=native -O3 -flto -pipe' modules sudo make modules_install sudo make install Where N is the number of cores you have, alternatively use $(getconf _NPROCESSORS_ONLN).\nIf any steps fail, run make clean and start again.\nMaking it default in grub (I am using grub2, your process might vary):\nsudo grub2-mkconfig -o /boot/grub2/grub.cfg sudo grubby --set-default /boot/vmlinuz-x.x.x-x You can find yours vmlinuz-x.x.x-x in /boot/\nNow restart and run uname -r to see your kernel.\nApplying patches There are several patches that you can use to increase performance or to make life simpler.\nThere are a lot of patches available, and you will have to find those that suit you best. I will be using graysky2 kernel patch here. Download the whole repo or just the file you need. In my case, I have GCC 10 and the latest kernel, so I will be using this .\nCopy the desired patch file into the root of the extracted linux dictionary; same place as .config.\npatch -p1 \u003c enable_additional_cpu_optimizations_for_gcc_v10.1+_kernel_v5.8+.patch\nYou should see an output like this:\npatching file arch/x86/Kconfig.cpu patching file arch/x86/Makefile patching file arch/x86/Makefile_32.cpu patching file arch/x86/include/asm/vermagic.h Now, you can start from step 4 in the previous setup and will see:\n- Processor type and features - Processor family - [x] Native optimizations autodetected by GCC There are other patches such as scheduling related that you can apply to. Again, try finding your patches that suits your system.\nRemoving your own compiled kernel Try to keep the last working kernel, i.e., have a minimum of two kernels (the one you are using and the previous one). NOTE: Removing the currently running kernel (determined by uname -r) will render your system non-bootable.\nThese entries need to be removed:\n/boot/vmlinuz-x.x.x-x /boot/initrd-x.x.x-x /boot/System-map-x.x.x-x /boot/config-x.x.x-x /lib/modules/x.x.x-x/ /var/lib/initramfs/x.x.x-x/ /boot/loader/entries/*x.x.x-x sudo grub2-mkconfig -o /boot/grub2/grub.cfg or sudo update-grub2\nBtrfs filesystem optimizations sudo gedit /etc/fstab, change it to look something like this (this is on fedora, yours might vary):\nUUID=\u003cdo-not-change\u003e / btrfs subvol=root,x-systemd.device-timeout=0,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async 0 0 UUID=\u003cdo-not-change\u003e /boot ext4 defaults 1 2 UUID=\u003cdo-not-change\u003e /boot/efi vfat umask=0077,shortname=winnt 0 2 UUID=\u003cdo-not-change\u003e /home btrfs subvol=home,x-systemd.device-timeout=0,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async 0 0 sudo systemctl daemon-reload\nsudo systemctl enable fstrim.timer\nChanging boot parameters Important: I usually like disabling mitigations, but then again, I am on AMD based CPU and do not have Meltdown only Spectre, I do not run an unknown script, and even if I have to, I use containers and firefox with noscript and a few other security add-ons. Nonetheless, if you understand the security concerns, you can disable it and see a substantial boost in performance.\nsudo grubby --args \"mitigations=off nowatchdog processor.ignore_ppc=1 amdgpu.ppfeaturemask=0xffffffff ec_sys.write_support=1 split_lock_detect=off\" --update-kernel=ALL OR\nsudo gedit /etc/default/grub\nYou will find a line GRUB_CMDLINE_LINUX=\" ... rhgb quiet change it to (... signifies other parameters):\nGRUB_CMDLINE_LINUX=\"... rhgb quiet mitigations=off nowatchdog processor.ignore_ppc=1 split_lock_detect=off\" Also, edit GRUB_TIMEOUT=5 to GRUB_TIMEOUT=1.\nsudo grub2-mkconfig -o /etc/grub2-efi.cfg\nOR\nsudo grub2-mkconfig -o /etc/grub2.cfg\nAfter rebooting, you can run cat /proc/cmdline to see your boot options.\nImproving boot time Our last tweak kinda improved it, but let’s try something more.\nRemove startup applications; I use gnome-tweaks for a GUI-like experience.\nRun the following to find what service is taking the longest:\nsystemd-analyze systemd-analyze blame systemd-analyze critical-chain These might vary from system to system and distro to distro; in my case(fedora), I disabled dnf-makecache.service. which took around 32s. To do so:\nsudo systemctl disable NetworkManager-wait-online.service sudo systemctl disable dnf-makecache.service sudo systemctl disable dnf-makecache.timer sudo gsettings set org.gnome.software download-updates false You might want to google every service that you think about disabling and what it does; in my case, it just updates dnf cache, which I usually like to do manually.\nChanging swappiness If you have 8GB or more ram, you might benefit from it; otherwise, leave it as it is.\nTo see current swappiness, enter cat /proc/sys/vm/swappiness; it should print 60; we want to make it 10.\nsudo gedit /etc/sysctl.conf\nEnter vm.swappiness=10 and reboot; now step 1 should print 10.\nChanging scaling_governor to performance Do not change it to performance on Ryzen based CPUs as it might(I seem to get better performance on AC, but then again, performance does not seem to allow turbo boost in some cases) hurt their performance, using ondemand. or schedutil is better (more leaning towards schedutil as soon as it gets fixed).\nRun cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor to see your current governor.\necho performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor\nThis setting most likely will not persist during the next boot; I like to change it manually rather than making a systemd service (I am a laptop, and it gets hot). You might want to google how to make it persistent for your distro if you like OR:\necho 'GOVERNOR=\"performance\"' | sudo tee /etc/default/cpufrequtils sudo systemctl disable schedutil The default is schedutil; you can see others here.\nNote: You can also change the default during the kernel compilation.\nImproving graphic card performance You can find overclocking tools specific to your GPU(s), but to make sure your graphics card isn’t being suppressed by the OS (especially AMD):\nChecking whether it is auto:\ncat /sys/class/drm/card0/device/power_dpm_force_performance_level cat /sys/class/drm/card1/device/power_dpm_force_performance_level Check the parameters of GPU by:\nsudo cat /sys/kernel/debug/dri/0/amdgpu_pm_info sudo cat /sys/kernel/debug/dri/1/amdgpu_pm_info Now set everything to high:\nsudo su echo high \u003e /sys/class/drm/card0/device/power_dpm_force_performance_level echo high \u003e /sys/class/drm/card1/device/power_dpm_force_performance_level You can change them back to auto if your system overheats.\nSome other tweaks ArchWiki/Improving performance\nDisabling Cool'n'Quiet or speedstep or PowerNow! from bios (will cause heat up on laptops, only enable it during gaming)\nCheck other bios features, too; they vary from system to system but should have a significant boost in performance\nUsing X instead of Wayland (may vary game to game)\nUsing Opengl backend in games instead of Vulkun (may vary game to game)\nContributing Feel free to open an issue or editing the README yourself on the Original Source on GitHub.\n",
  "wordCount" : "1418",
  "inLanguage": "en",
  "datePublished": "2021-01-26T00:00:00Z",
  "dateModified": "2021-01-26T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "sn99"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nidhihemanth.github.io./blogs/optimizing-linux/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "sn99",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nidhihemanth.github.io./favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nidhihemanth.github.io." accesskey="h" title="sn99 (Alt + H)">sn99</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nidhihemanth.github.io./about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://nidhihemanth.github.io./blogs" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://nidhihemanth.github.io./contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://nidhihemanth.github.io.">Home</a>&nbsp;»&nbsp;<a href="https://nidhihemanth.github.io./blogs/">Blogs</a></div>
    <h1 class="post-title entry-hint-parent">
      Optimizing Linux
    </h1>
    <div class="post-meta"><span title='2021-01-26 00:00:00 +0000 UTC'>January 26, 2021</span>&nbsp;·&nbsp;sn99

</div>
  </header> 
  <div class="post-content"><p>I am writing this guide to save my progress and let others contribute to increasing linux performance even further;
after
all, many are better than one. You can use all of them or just a few of them. <strong>Read a topic fully before starting</strong>.</p>
<p>I am currently on <a href="https://nobaraproject.org/">Nobara</a>, so some steps may vary from distro to distro.</p>
<p><strong>NOTE: This guide is not for beginners who are new to Linux</strong> but a few of them can be used safely by them.</p>
<h2 id="index">Index<a hidden class="anchor" aria-hidden="true" href="#index">#</a></h2>
<ul>
<li><a href="#compiling-your-kernel">Compiling your kernel</a>
<ul>
<li><a href="#applying-patches">Applying patches</a></li>
<li><a href="#removing-your-own-compiled-kernel">Removing your own compiled kernel</a></li>
</ul>
</li>
<li><a href="#btrfs-filesystem-optimizations">Btrfs filesystem optimizations</a></li>
<li><a href="#changing-boot-parameters">Changing boot parameters</a></li>
<li><a href="#improving-boot-time">Improving boot time</a></li>
<li><a href="#changing-swappiness">Changing swappiness</a></li>
<li><a href="#changing-scaling_governor-to-performance">Changing scaling_governor to performance</a></li>
<li><a href="#improving-graphic-card-performance">Improving graphic card performance</a></li>
<li><a href="#some-other-tweaks">Some other tweaks</a></li>
</ul>
<h2 id="compiling-your-kernel">Compiling your kernel<a hidden class="anchor" aria-hidden="true" href="#compiling-your-kernel">#</a></h2>
<p>By now, everyone agrees that compiling your kernel is one of the best options to get the fastest possible speed.
You might want to google <code>How to make custom kernel in &lt;distro&gt;</code> to get the packages required to compile the kernel.</p>
<ol>
<li>
<p>Download the <a href="https://www.kernel.org/">latest kernel</a> or whatever you like. Extract it; I am going to assume a
generic name from now on <code>linux-x.x.x</code>.</p>
</li>
<li>
<p>The next step is finding the <code>config</code> file. Most of the time, you can run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp -v /boot/config-<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span> .config
</span></span></code></pre></div><p>From inside <code>linux-x.x.x</code>, which should give an output like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#e6db74">&#39;/boot/config-y.y.y-generic&#39;</span> -&gt; <span style="color:#e6db74">&#39;.config&#39;</span>
</span></span></code></pre></div><p>if it fails, you can find config in <code>/proc/config.gz</code> or simple run <code>make listnewconfig</code> OR <code>make oldconfig</code>(it
usually starts a long process; try finding your config in your distro source code too).</p>
</li>
<li>
<p>Edit <code>Makefile</code> and change <code>EXTRAVERSION</code> to add something. For example, &ldquo;EXTRAVERSION = &lt;yourname&gt;&rdquo;.</p>
</li>
<li>
<p>(You might want to see the next subtopic before doing this) Now run <code>make xconfig</code>. Now a lot of optimizations are
possible
Here, many dead codes and modules can be removed and enabled. Let&rsquo;s go the safe road for now.</p>
<ul>
<li>Now, one of the best things you can do is no longer build for a generic kernel. Select
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#66d9ef">-</span> Processor type and features
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">-</span> Processor family
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">- [x]</span> Core2/newer Xeon
</span></span></code></pre></div>It should have been <code>Generic-x86-64</code> by default.</li>
<li>There is a lot of other stuff you can do too, but you will have to read them and see which suits
you best. A simple way might be to just copy <a href="https://github.com/clearlinux-pkgs/linux">clear linux config</a>, but
it might disable certain features (see next <a href="#applying-patches">Applying patches</a>).</li>
</ul>
</li>
<li>
<p>Now, you might want to run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dmesg --level<span style="color:#f92672">=</span>err
</span></span><span style="display:flex;"><span>dmesg --level<span style="color:#f92672">=</span>warn   
</span></span></code></pre></div><p>To see if you can enable some extra flags for extra features. For
example, <code>psmouse serio1: elantech: The touchpad can support a better bus than the old PS/2 protocol. Make sure MOUSE_PS2_ELANTECH_SMBUS and MOUSE_ELAN_I2C_SMBUS are enabled to get a better touchpad experience.</code>
can be solved by enabling both of them.</p>
</li>
<li>
<p>Finally, compiling the kernel:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># sed -ri &#39;/CONFIG_SYSTEM_TRUSTED_KEYS/s/=.+/=&#34;&#34;/g&#39; .config</span>
</span></span><span style="display:flex;"><span>make -j N CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-march=native -O3 -flto -pipe&#39;</span> CXXFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-march=native -O3 -flto -pipe&#39;</span>
</span></span><span style="display:flex;"><span>make -j N CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-march=native -O3 -flto -pipe&#39;</span> CXXFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-march=native -O3 -flto -pipe&#39;</span> modules
</span></span><span style="display:flex;"><span>sudo make modules_install
</span></span><span style="display:flex;"><span>sudo make install
</span></span></code></pre></div><p>Where <code>N</code> is the number of <code>cores</code> you have, alternatively use <code>$(getconf _NPROCESSORS_ONLN)</code>.</p>
<p>If any steps fail, run <code>make clean</code> and start again.</p>
</li>
<li>
<p>Making it default in grub (I am using grub2, your process might vary):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span style="display:flex;"><span>sudo grubby --set-default /boot/vmlinuz-x.x.x-x
</span></span></code></pre></div><p>You can find yours <code>vmlinuz-x.x.x-x</code> in <code>/boot/</code></p>
</li>
</ol>
<p>Now restart and run <code>uname -r</code> to see your kernel.</p>
<h3 id="applying-patches">Applying patches<a hidden class="anchor" aria-hidden="true" href="#applying-patches">#</a></h3>
<p>There are several patches that you can use to increase performance or to make life simpler.</p>
<p>There are a lot of patches available, and you will have to find those that suit you best. I will be
using <a href="https://github.com/graysky2/kernel_gcc_patch">graysky2</a> kernel patch here. Download the
whole <a href="https://github.com/graysky2/kernel_gcc_patch">repo</a> or just the file you need. In my case, I have GCC 10 and
the latest kernel, so I will be
using <a href="https://github.com/graysky2/kernel_gcc_patch/blob/master/enable_additional_cpu_optimizations_for_gcc_v10.1%2B_kernel_v5.8%2B.patch">this</a>
.</p>
<ol>
<li>
<p>Copy the desired patch file into the root of the extracted linux dictionary; same place as <code>.config</code>.</p>
</li>
<li>
<p><code>patch -p1 &lt; enable_additional_cpu_optimizations_for_gcc_v10.1+_kernel_v5.8+.patch</code></p>
<p>You should see an output like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>patching file arch/x86/Kconfig.cpu
</span></span><span style="display:flex;"><span>patching file arch/x86/Makefile
</span></span><span style="display:flex;"><span>patching file arch/x86/Makefile_32.cpu
</span></span><span style="display:flex;"><span>patching file arch/x86/include/asm/vermagic.h
</span></span></code></pre></div></li>
<li>
<p>Now, you can start from step 4 in the previous setup and will see:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#66d9ef">-</span>  Processor type and features
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">-</span> Processor family
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">- [x]</span> Native optimizations autodetected by GCC
</span></span></code></pre></div></li>
</ol>
<p>There are other patches such as <a href="https://cchalpha.blogspot.com/">scheduling related</a> that you can apply to. Again, try
finding your patches that suits your system.</p>
<h3 id="removing-your-own-compiled-kernel">Removing your own compiled kernel<a hidden class="anchor" aria-hidden="true" href="#removing-your-own-compiled-kernel">#</a></h3>
<p>Try to keep the last working kernel, i.e., have a minimum of two kernels (the one you are using and the previous one).
<strong>NOTE:</strong> Removing the currently running kernel (determined by <code>uname -r</code>) will render your system
non-bootable.</p>
<ol>
<li>
<p>These entries need to be removed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/boot/vmlinuz-x.x.x-x
</span></span><span style="display:flex;"><span>/boot/initrd-x.x.x-x
</span></span><span style="display:flex;"><span>/boot/System-map-x.x.x-x
</span></span><span style="display:flex;"><span>/boot/config-x.x.x-x
</span></span><span style="display:flex;"><span>/lib/modules/x.x.x-x/
</span></span><span style="display:flex;"><span>/var/lib/initramfs/x.x.x-x/
</span></span><span style="display:flex;"><span>/boot/loader/entries/*x.x.x-x
</span></span></code></pre></div></li>
<li>
<p><code>sudo grub2-mkconfig -o /boot/grub2/grub.cfg</code> or <code>sudo update-grub2</code></p>
</li>
</ol>
<h2 id="btrfs-filesystem-optimizations">Btrfs filesystem optimizations<a hidden class="anchor" aria-hidden="true" href="#btrfs-filesystem-optimizations">#</a></h2>
<ol>
<li>
<p><code>sudo gedit /etc/fstab</code>, change it to look something like this (this is on fedora, yours might vary):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>UUID<span style="color:#f92672">=</span>&lt;<span style="color:#66d9ef">do</span>-not-change&gt; /                       btrfs   subvol<span style="color:#f92672">=</span>root,x-systemd.device-timeout<span style="color:#f92672">=</span>0,ssd,noatime,space_cache,commit<span style="color:#f92672">=</span>120,compress<span style="color:#f92672">=</span>zstd,discard<span style="color:#f92672">=</span>async <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>UUID<span style="color:#f92672">=</span>&lt;<span style="color:#66d9ef">do</span>-not-change&gt; /boot                   ext4    defaults        <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>UUID<span style="color:#f92672">=</span>&lt;<span style="color:#66d9ef">do</span>-not-change&gt;          /boot/efi               vfat    umask<span style="color:#f92672">=</span>0077,shortname<span style="color:#f92672">=</span>winnt <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>UUID<span style="color:#f92672">=</span>&lt;<span style="color:#66d9ef">do</span>-not-change&gt; /home                   btrfs   subvol<span style="color:#f92672">=</span>home,x-systemd.device-timeout<span style="color:#f92672">=</span>0,ssd,noatime,space_cache,commit<span style="color:#f92672">=</span>120,compress<span style="color:#f92672">=</span>zstd,discard<span style="color:#f92672">=</span>async <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div></li>
<li>
<p><code>sudo systemctl daemon-reload</code></p>
</li>
<li>
<p><code>sudo systemctl enable fstrim.timer</code></p>
</li>
</ol>
<h2 id="changing-boot-parameters">Changing boot parameters<a hidden class="anchor" aria-hidden="true" href="#changing-boot-parameters">#</a></h2>
<p><strong>Important:</strong> I usually like disabling <code>mitigations</code>, but then again, I am on <code>AMD</code> based CPU and do not
have <code>Meltdown</code>
only <code>Spectre</code>, I do not run an unknown script, and even if I have to, I use containers and firefox with <code>noscript</code> and
a
few other security add-ons. Nonetheless, if you understand the security concerns, you can disable it and see a
substantial
boost in performance.</p>
<ol>
<li><code>sudo grubby --args &quot;mitigations=off nowatchdog processor.ignore_ppc=1 amdgpu.ppfeaturemask=0xffffffff ec_sys.write_support=1 split_lock_detect=off&quot; --update-kernel=ALL</code></li>
</ol>
<p>OR</p>
<ol>
<li>
<p><code>sudo gedit /etc/default/grub</code></p>
</li>
<li>
<p>You will find a line <code>GRUB_CMDLINE_LINUX=&quot; ... rhgb quiet</code> change it to (<code>...</code> signifies other parameters):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>GRUB_CMDLINE_LINUX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;... rhgb quiet mitigations=off nowatchdog processor.ignore_ppc=1 split_lock_detect=off&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>Also, edit <code>GRUB_TIMEOUT=5</code> to <code>GRUB_TIMEOUT=1.</code></p>
</li>
<li>
<p><code>sudo grub2-mkconfig -o /etc/grub2-efi.cfg</code></p>
<p>OR</p>
<p><code>sudo grub2-mkconfig -o /etc/grub2.cfg</code></p>
</li>
</ol>
<p>After rebooting, you can run <code>cat /proc/cmdline</code> to see your boot options.</p>
<h2 id="improving-boot-time">Improving boot time<a hidden class="anchor" aria-hidden="true" href="#improving-boot-time">#</a></h2>
<p>Our last tweak kinda improved it, but let&rsquo;s try something more.</p>
<ol>
<li>
<p>Remove startup applications; I use <code>gnome-tweaks</code> for a GUI-like experience.</p>
</li>
<li>
<p>Run the following to find what service is taking the longest:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemd-analyze
</span></span><span style="display:flex;"><span>systemd-analyze blame
</span></span><span style="display:flex;"><span>systemd-analyze critical-chain
</span></span></code></pre></div><p>These might vary from system to system and distro to distro; in my case(fedora), I disabled <code>dnf-makecache.service.</code>
which took around <code>32s</code>. To do so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo systemctl disable NetworkManager-wait-online.service
</span></span><span style="display:flex;"><span>sudo systemctl disable dnf-makecache.service 
</span></span><span style="display:flex;"><span>sudo systemctl disable dnf-makecache.timer
</span></span><span style="display:flex;"><span>sudo gsettings set org.gnome.software download-updates false
</span></span></code></pre></div><p>You might want to google every service that you think about disabling and what it does; in my case, it just updates
dnf
cache, which I usually like to do manually.</p>
</li>
</ol>
<h2 id="changing-swappiness">Changing swappiness<a hidden class="anchor" aria-hidden="true" href="#changing-swappiness">#</a></h2>
<p>If you have 8GB or more ram, you might benefit from it; otherwise, leave it as it is.</p>
<ol>
<li>
<p>To see current swappiness, enter <code>cat /proc/sys/vm/swappiness</code>; it should print <code>60</code>; we want to make it 10.</p>
</li>
<li>
<p><code>sudo gedit /etc/sysctl.conf</code></p>
</li>
<li>
<p>Enter <code>vm.swappiness=10</code> and reboot; now step 1 should print 10.</p>
</li>
</ol>
<h2 id="changing-scaling_governor-to-performance">Changing <code>scaling_governor</code> to <code>performance</code><a hidden class="anchor" aria-hidden="true" href="#changing-scaling_governor-to-performance">#</a></h2>
<p>Do not change it to <code>performance</code> on Ryzen based CPUs as it <strong><em>might</em></strong>(I seem to get better performance on AC, but then
again, <code>performance</code> does not seem to allow turbo boost in some cases) hurt their performance, using <code>ondemand</code>.
or <code>schedutil</code> is better (more leaning towards <code>schedutil</code> as soon as it
gets <a href="https://www.phoronix.com/scan.php?page=article&amp;item=linux511-amd-patch&amp;num=1">fixed</a>).</p>
<ol>
<li>
<p>Run <code>cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</code> to see your current governor.</p>
</li>
<li>
<p><code>echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</code></p>
<p>This setting most likely will not persist during the next boot; I like to change it manually rather than making a
systemd service (I am a laptop, and it gets hot). You might want to google how to make it persistent for your distro
if
you like OR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;GOVERNOR=&#34;performance&#34;&#39;</span> | sudo tee /etc/default/cpufrequtils
</span></span><span style="display:flex;"><span>sudo systemctl disable schedutil 
</span></span></code></pre></div><p>The default is <code>schedutil</code>; you can see
others <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html">here</a>.</p>
</li>
</ol>
<p><strong>Note</strong>: You can also change the default during the kernel compilation.</p>
<h2 id="improving-graphic-card-performance">Improving graphic card performance<a hidden class="anchor" aria-hidden="true" href="#improving-graphic-card-performance">#</a></h2>
<p>You can find overclocking tools specific to your GPU(s), but to make sure your graphics card isn’t being suppressed by
the OS (especially AMD):</p>
<ol>
<li>
<p>Checking whether it is <code>auto</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat /sys/class/drm/card0/device/power_dpm_force_performance_level
</span></span><span style="display:flex;"><span>cat /sys/class/drm/card1/device/power_dpm_force_performance_level
</span></span></code></pre></div></li>
<li>
<p>Check the parameters of GPU by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo cat /sys/kernel/debug/dri/0/amdgpu_pm_info
</span></span><span style="display:flex;"><span>sudo cat /sys/kernel/debug/dri/1/amdgpu_pm_info
</span></span></code></pre></div></li>
<li>
<p>Now set everything to high:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo su
</span></span><span style="display:flex;"><span>echo high &gt; /sys/class/drm/card0/device/power_dpm_force_performance_level
</span></span><span style="display:flex;"><span>echo high &gt; /sys/class/drm/card1/device/power_dpm_force_performance_level
</span></span></code></pre></div><p>You can change them back to <code>auto</code> if your system overheats.</p>
</li>
</ol>
<h2 id="some-other-tweaks">Some other tweaks<a hidden class="anchor" aria-hidden="true" href="#some-other-tweaks">#</a></h2>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/index.php/Improving_performance">ArchWiki/Improving performance</a></p>
</li>
<li>
<p>Disabling <code>Cool'n'Quiet</code> or <code>speedstep</code> or <code>PowerNow!</code> from bios (will cause heat up on laptops, only enable it during
gaming)</p>
</li>
<li>
<p>Check other bios features, too; they vary from system to system but should have a significant boost in performance</p>
</li>
<li>
<p>Using <code>X</code> instead of <code>Wayland</code> (may vary game to game)</p>
</li>
<li>
<p>Using <code>Opengl</code> backend in games instead of <code>Vulkun</code> (may vary game to game)</p>
</li>
</ul>
<h2 id="contributing">Contributing<a hidden class="anchor" aria-hidden="true" href="#contributing">#</a></h2>
<p>Feel free to open an <a href="https://github.com/sn99/Optimizing-linux/issues/new">issue</a>
or <a href="https://github.com/sn99/Optimizing-linux/edit/master/README.md">editing the README</a> yourself on the <em><a href="https://github.com/sn99/Optimizing-linux">Original Source</a></em> on GitHub.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://nidhihemanth.github.io./tags/windows/">Windows</a></li>
      <li><a href="https://nidhihemanth.github.io./tags/drivers/">Drivers</a></li>
      <li><a href="https://nidhihemanth.github.io./tags/minifilter/">minifilter</a></li>
      <li><a href="https://nidhihemanth.github.io./tags/virtualkd-redux/">VirtualKD-Redux</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://nidhihemanth.github.io./blogs/virtualkd-redux/">
    <span class="title">Next »</span>
    <br>
    <span>Setting up a Windows machine for drivers and minifilters, testing and debugging using VirtualKD-Redux</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://nidhihemanth.github.io.">sn99</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
